<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Annotator Desktop-First</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <style>
        :root { --primary: #00b3ff; --bg: #f4f7f9; --highlight: #e0f4ff; }
        
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 0; }

        /* LAYOUT DESKTOP (Default sopra i 992px) */
        .main-layout {
            display: flex;
            flex-direction: row-reverse; /* Video a DESTRA, Tabella a SINISTRA */
            gap: 20px;
            padding: 20px;
            max-width: 100%;
            height: 100vh;
            box-sizing: border-box;
        }

        /* Colonna Video */
        .video-column {
            flex: 2; /* Prende lo spazio maggiore */
            min-width: 0;
        }

        .video-wrapper {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16 / 9;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: sticky;
            top: 20px;
        }

        /* Colonna Tabella */
        .table-column {
            flex: 0 0 400px; /* Larghezza FISSA su desktop */
            min-width: 300px;
            display: flex;
            flex-direction: column;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            overflow-y: auto;
            height: 100%;
        }

        table { width: 100%; border-collapse: collapse; text-align: left; font-size: 0.85rem; }
        th { background: #f8fafc; color: #64748b; padding: 12px; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 10; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        
        tr.active-row td { background-color: var(--highlight); font-weight: bold; color: var(--primary); border-left: 4px solid var(--primary); }

        .btn-play { background: var(--primary); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }

        /* --- LAYOUT MOBILE (Sotto i 992px o Smartphone Verticale) --- */
        @media (max-width: 991px) {
            .main-layout {
                flex-direction: column; /* Video SOPRA, Tabella SOTTO */
                height: auto;
            }
            .table-column {
                flex: none;
                width: 100%;
                max-width: 100%;
            }
            .video-column {
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <div class="main-layout">
        <div class="video-column">
            <div class="video-wrapper">
                <div id="player-container">
                    <div id="player" data-plyr-provider="youtube" data-plyr-embed-id="aqz-KE-bpKQ"></div>
                </div>
            </div>
        </div>

        <div class="table-column">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Commento</th>
                            <th>Sec</th>
                            <th>Play</th>
                        </tr>
                    </thead>
                    <tbody id="video-table-body">
                        </tbody>
                </table>
                <div id="loader" style="padding: 20px; text-align: center;">Caricamento...</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script>
        let player;
        let currentVideoId = "";
        const plyrConfig = { invertTime: false, displayDuration: true, controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'] };

        player = new Plyr('#player', plyrConfig);

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const jsonUrl = params.get('src');

            if (!jsonUrl) {
                document.getElementById('loader').innerText = "Manca ?src=file.json nella URL";
                return;
            }

            try {
                const response = await fetch(jsonUrl);
                const data = await response.json();
                buildTable(data);
                document.getElementById('loader').style.display = 'none';
            } catch (err) {
                document.getElementById('loader').innerText = "Errore caricamento JSON";
            }
        }

        function buildTable(data) {
            const tbody = document.getElementById('video-table-body');
            tbody.innerHTML = "";
            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.indice || index + 1}</td>
                    <td>${item.commento}</td>
                    <td>${item.time}</td>
                    <td><button class="btn-play" onclick="handleRowPlay(this, '${item.url}')">â–¶</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function extractInfo(url) {
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
                return { id: (match && match[2].length === 11) ? match[2] : null, provider: 'youtube' };
            }
            if (url.includes('vimeo.com')) {
                const match = url.match(/(?:vimeo\.com\/)(\d+)/);
                return { id: (match && match[1]) ? match[1] : null, provider: 'vimeo' };
            }
            return null;
        }

        function handleRowPlay(button, url) {
            const row = button.closest('tr');
            const time = parseInt(row.querySelector('td:nth-child(3)').innerText) || 0;
            const info = extractInfo(url);
            if (!info) return;

            document.querySelectorAll('tr').forEach(r => r.classList.remove('active-row'));
            row.classList.add('active-row');

            if (info.id === currentVideoId) {
                player.currentTime = time;
                player.play();
            } else {
                currentVideoId = info.id;
                loadNewSource(info.provider, info.id, time);
            }
        }

        function loadNewSource(provider, id, time) {
            player.destroy();
            document.getElementById('player-container').innerHTML = `<div id="player" data-plyr-provider="${provider}" data-plyr-embed-id="${id}"></div>`;
            player = new Plyr('#player', plyrConfig);
            player.on('ready', () => {
                setTimeout(() => {
                    player.currentTime = time;
                    player.play().catch(() => { player.muted = true; player.play(); });
                }, 1200);
            });
        }

        window.onload = init;
    </script>
</body>
</html>